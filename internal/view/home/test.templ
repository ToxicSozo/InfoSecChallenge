package home

import "github.com/ToxicSozo/InfoSecChallenge/internal/view/layout"

templ Test(score int) {
    @layout.Base(layout.BaseProps{Title: "CTF"}) {
        <div class="container mx-auto p-4">
            <h1 class="text-3xl font-bold mb-6">Welcome to the InfoSec Challenge</h1>

            <!-- Crypto Section -->
            <h2 class="text-2xl font-semibold mb-4">Crypto</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Task 1 -->
                <div class="card bg-base-200 shadow-xl" data-task-id="1">
                    <div class="card-body">
                        <h3 class="card-title">Никак не могу разглядеть</h3>
                        <div class="collapse">
                            <input type="checkbox" id="crypto-task-1" class="peer" />
                            <div class="collapse-title" for="crypto-task-1">
                                Нажмите, чтобы посмотреть детали
                            </div>
                            <div class="collapse-content">
                                <p>Однажды мне понабилось написать базированное сообщение своему слепому другу. К сожалению, он не смог ничего разобрать... Я решил, что стоит попробовать написать ему иначе, но ответа так и не поступило... Может, вы сможете ему помочь?</p>
                                <p>Формат флага: <code>InfoSec_CTF{`{}`}</code></p>
                                <a href="/assets/crypto1.txt" download class="btn btn-primary mt-4">Скачать</a>
                                <div class="mt-4">
                                    <form class="flag-form">
                                        <input type="text" placeholder="Enter flag" class="input input-bordered w-full max-w-xs" />
                                        <button type="button" class="btn btn-secondary mt-2 flag-submit-button">Отправить флаг</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task 2 -->
                <div class="card bg-base-200 shadow-xl" data-task-id="2">
                    <div class="card-body">
                        <h3 class="card-title">F1Z1K1 ОТДЫХАЮТ</h3>
                        <div class="collapse">
                            <input type="checkbox" id="crypto-task-2" class="peer" />
                            <div class="collapse-title" for="crypto-task-2">
                                Нажмите, чтобы посмотреть детали
                            </div>
                            <div class="collapse-content">
                                <p>Мой друг физик однажды сказал, что магия - это всего лишь физика, которую мы еще не поняли. С его точки зрения, мир полон чудес, которые могут казаться магическими, но на самом деле они - результат законов физики. В конце концов, радуга может казаться магической, пока вы не узнаете о дисперсии света. Так что для физика, нет ничего магического, есть только явления, которые мы еще не объяснили.</p>
                                <a href="/assets/crypto2.py" download class="btn btn-primary mt-4">Скачать</a>
                                <!-- Поле для ввода флага -->
                                <div class="mt-4">
                                    <input type="text" placeholder="Enter flag" class="input input-bordered w-full max-w-xs" />
                                    <button class="btn btn-secondary mt-2 flag-submit-button">Отправить флаг</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OSINT Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">OSINT</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Task 1 -->
                <div class="card bg-base-200 shadow-xl" data-task-id="3">
                    <div class="card-body">
                        <h3 class="card-title">Тайна Гермеуса Моры</h3>
                        <div class="collapse">
                            <input type="checkbox" id="osint-task-1" class="peer" />
                            <div class="collapse-title" for="osint-task-1">
                                Нажмите, чтобы посмотреть детали
                            </div>
                            <div class="collapse-content" style="max-height: 300px; overflow-y: auto;">
                                <p>Описание: Гермеус Мора, Даэдрический Принц знаний и судьбы, оставил загадку для тех, кто ищет истину. Он спрятал флаг в своём Telegram-аккаунте, но чтобы найти его, вам нужно расшифровать подсказки, связанные с его сущностью и песней, вдохновлённой им.</p>
                                <p>Условия: Гермеус Мора оставил сообщение:</p>
                                <ul>
                                    <li>Ищите меня там, где знания скрыты в тенях.</li>
                                    <li>Мой Telegram — это моё имя и число, но не ищите меня в кириллице.</li>
                                    <li>Вдохновление ищите в песне, где я — главный герой123.</li>
                                </ul>
                                <p>Формат флага: <code>InfoSec_CTF{`{}`}</code></p>
                                <div class="mt-4">
                                    <input type="text" placeholder="Enter flag" class="input input-bordered w-full max-w-xs" />
                                    <button class="btn btn-secondary mt-2 flag-submit-button">Отправить флаг</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task 2 -->
                <div class="card bg-base-200 shadow-xl" data-task-id="4">
                    <div class="card-body">
                        <h3 class="card-title">Кто же он такой???</h3>
                        <div class="collapse">
                            <input type="checkbox" id="osint-task-2" class="peer" />
                            <div class="collapse-title" for="osint-task-2">
                                Нажмите, чтобы посмотреть детали
                            </div>
                            <div class="collapse-content">
                                <p>Описание: "Этот герой — мастер выживания в мире, где каждый день — это борьба древних меж собой. Он знает, что важно не только то, что ты можешь найти, но и то, как ты это используешь. Его дом — это руины древней цивилизации, где каждый камень хранит историю, а каждый кристалл — силу. Он избегает сильных, охотится на слабых и всегда знает, как извлечь выгоду из того, что другие считают бесполезным. Его имя начинается на 'М' и заканчивается на 'о', а его стиль жизни — это философия хитрости и находчивости.</p>
                                <div class="mt-4">
                                    <input type="text" placeholder="Enter flag" class="input input-bordered w-full max-w-xs" />
                                    <button class="btn btn-secondary mt-2 flag-submit-button">Отправить флаг</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">Тест на знания</h2>
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <form id="quiz-form">
                        <!-- Question 1 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">1. Какой тип шифрования использует асимметричные ключи?</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="q1" value="a" class="mr-2">
                                    DNS Spoofing
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q1" value="b" class="mr-2">
                                    ARP Poisoning
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q1" value="c" class="mr-2">
                                    SQL Injection
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q1" value="d" class="mr-2">
                                    Cross-Site Scripting (XSS)
                                </label>
                            </div>
                        </div>

                        <!-- Question 2 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">2. Какой из перечисленных методов является наиболее эффективным для защиты от атак типа "человек посередине" (Man-in-the-Middle)?</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="q2" value="a" class="mr-2">
                                    Использование VPN
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q2" value="b" class="mr-2">
                                    Регулярное обновление антивируса
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q2" value="c" class="mr-2">
                                    Установка брандмауэра
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q2" value="c" class="mr-2">
                                    Отключение JavaScript в браузере
                                </label>
                            </div>
                        </div>

                        <!-- Question 3 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">3. Какой из следующих стандартов регулирует управление информационной безопасностью в организации?</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="q3" value="a" class="mr-2">
                                    ISO 27001
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q3" value="b" class="mr-2">
                                    PCI DSS
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q3" value="c" class="mr-2">
                                    GDPR
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q3" value="c" class="mr-2">
                                    HIPAA
                                </label>
                            </div>
                        </div>

                        <!-- Question 4 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">4. Какой тип шифрования использует асимметричные ключи?</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="q4" value="a" class="mr-2">
                                    AES
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q4" value="b" class="mr-2">
                                    RSA
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q4" value="c" class="mr-2">
                                    DES
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q4" value="c" class="mr-2">
                                    Blowfish
                                </label>
                            </div>
                        </div>

                        <!-- Question 5 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">5. Какой из перечисленных методов является примером социальной инженерии?</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="q5" value="a" class="mr-2">
                                    Фишинг
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q5" value="b" class="mr-2">
                                    Эксплуатация уязвимостей нулевого дня (Zero-Day)
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q5" value="c" class="mr-2">
                                    Использование руткитов
                                </label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary mt-4">Отправить ответы</button>
                    </form>
                </div>
            </div>

            <!-- Отображение баллов пользователя внизу страницы -->
            <div class="mt-8 p-4 bg-base-200 rounded-lg">
                <h2 class="text-2xl font-semibold">Ваши баллы: <span id="user-score" class="text-primary">@score</span></h2>
            </div>
        </div>

        <!-- JavaScript для управления раскрытием задач -->
        <script>
            document.addEventListener("click", function (event) {
                const tasks = document.querySelectorAll(".collapse input[type='checkbox']");
                const clickedElement = event.target;

                // Проверяем, был ли клик вне области задачи
                let isClickInsideTask = false;
                tasks.forEach(task => {
                    if (task.parentElement.contains(clickedElement)) {
                        isClickInsideTask = true;
                    }
                });

                // Если клик был вне задачи, закрываем все задачи
                if (!isClickInsideTask) {
                    tasks.forEach(task => {
                        task.checked = false;
                    });
                }
            });

            document.getElementById('quiz-form').addEventListener('submit', function (event) {
                event.preventDefault();
                alert('Ответы отправлены!');
            });

            // Обновление баллов
            function updateScore() {
                fetch("/get-score")
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("user-score").textContent = data.score;
                    })
                    .catch(error => {
                        console.error("Ошибка при обновлении баллов:", error);
                    });
            }

            // Обновляем баллы при загрузке страницы
            updateScore();

            // Обновляем баллы после отправки флага
            document.querySelectorAll(".flag-submit-button").forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    const flagInput = button.closest(".flag-form").querySelector("input[type='text']");
                    const flag = flagInput.value.trim();
                    const taskID = button.closest(".card").dataset.taskId;

                    if (flag === "") {
                        alert("Пожалуйста, введите флаг.");
                        return;
                    }

                    fetch("/submit-flag", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: `flag=${encodeURIComponent(flag)}&task_id=${encodeURIComponent(taskID)}`,
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error("Неверный флаг.");
                        }
                    })
                    .then(message => {
                        alert(message);
                        updateScore(); // Обновляем баллы после успешной отправки флага
                    })
                    .catch(error => {
                        alert(error.message);
                    });
                });
            });
        </script>
    }
}